<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Companion</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f3f4f6;
            padding: 1rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        h1 {
            font-size: 1.75rem;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        
        .controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #2563eb;
        }
        
        .btn-primary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        
        .filters-panel {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: none;
        }
        
        .filters-panel.show {
            display: block;
        }
        
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .categories {
            margin-bottom: 1.5rem;
        }
        
        .categories h4 {
            font-size: 0.875rem;
            color: #374151;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .category-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .category-btn {
            padding: 0.375rem 0.875rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            border: 1px solid #d1d5db;
            background-color: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .category-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .distance-control h4 {
            font-size: 0.875rem;
            color: #374151;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .slider {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .message {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        
        .message-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .message-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .message-info {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .message-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .location-status {
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .location-status h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .coords {
            font-family: monospace;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .results {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        
        .results h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: #1f2937;
        }
        
        .place-list {
            display: grid;
            gap: 1rem;
        }
        
        .place-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all 0.2s;
        }
        
        .place-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .place-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }
        
        .place-name {
            font-weight: 600;
            font-size: 1rem;
            color: #1f2937;
        }
        
        .place-category {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            color: #6b7280;
            background-color: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        
        .place-details {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.75rem;
        }
        
        .place-details p {
            margin-bottom: 0.25rem;
        }
        
        .place-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .action-link {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            text-decoration: none;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .directions-link {
            background-color: #3b82f6;
            color: white;
        }
        
        .directions-link:hover {
            background-color: #2563eb;
        }
        
        .website-link {
            background-color: #6b7280;
            color: white;
        }
        
        .website-link:hover {
            background-color: #4b5563;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        
        .spinner {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            border: 3px solid #f3f4f6;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó∫Ô∏è Travel Companion</h1>
        
        <div class="controls">
            <button id="searchBtn" class="btn btn-primary" disabled>
                <span>üîç</span>
                <span id="searchBtnText">Search Nearby</span>
            </button>
            <button id="filterBtn" class="btn btn-secondary">
                <span>‚öôÔ∏è</span>
                <span>Filters <span id="filterCount"></span></span>
            </button>
        </div>
        
        <div id="filtersPanel" class="filters-panel">
            <div class="filter-header">
                <h3>Filters</h3>
                <button class="btn btn-secondary" onclick="toggleFilters()">Close</button>
            </div>
            
            <div class="categories">
                <h4>Categories</h4>
                <div class="category-buttons" id="categoryButtons"></div>
            </div>
            
            <div class="distance-control">
                <h4 id="distanceLabel">Maximum Distance: 1km</h4>
                <input type="range" id="distanceSlider" class="slider" min="100" max="5000" step="100" value="1000">
                <div class="slider-labels">
                    <span>100m</span>
                    <span>2.5km</span>
                    <span>5km</span>
                </div>
            </div>
        </div>
        
        <div id="messages"></div>
        
        <div id="locationStatus" class="location-status" style="display: none;">
            <h3>üìç Your Location</h3>
            <p class="coords" id="coords"></p>
        </div>
    </div>
    
    <div class="results">
        <h2 id="resultsTitle">Nearby Places</h2>
        <div id="placeList" class="place-list">
            <div class="empty-state">
                <div class="empty-state-icon">üìç</div>
                <p>Allow location access and click "Search Nearby" to find places around you</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let userLocation = null;
        let places = [];
        let selectedCategories = ['restaurant', 'cafe', 'bar', 'attraction'];
        let maxDistance = 1000;

        // Categories configuration
        const categories = [
            { id: 'restaurant', label: 'Restaurants', emoji: 'üçΩÔ∏è', query: 'amenity=restaurant' },
            { id: 'cafe', label: 'Cafes', emoji: '‚òï', query: 'amenity=cafe' },
            { id: 'bar', label: 'Bars', emoji: 'üç∫', query: 'amenity=bar|amenity=pub' },
            { id: 'attraction', label: 'Attractions', emoji: 'üì∏', query: 'tourism=attraction|tourism=museum|tourism=gallery' },
            { id: 'park', label: 'Parks', emoji: 'üå≥', query: 'leisure=park|leisure=garden' },
            { id: 'trail', label: 'Trails', emoji: 'ü•æ', query: 'highway=footway|highway=path' },
        ];

        // Initialize
        function init() {
            initUI();
            getUserLocation();
        }

        // Get user location
        function getUserLocation() {
            if (!navigator.geolocation) {
                showMessage('Geolocation is not supported by your browser.', 'error');
                return;
            }

            showMessage('Getting your location...', 'warning');
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    const { latitude, longitude } = position.coords;
                    userLocation = [latitude, longitude];
                    
                    // Show location status
                    document.getElementById('locationStatus').style.display = 'block';
                    document.getElementById('coords').textContent = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                    
                    // Enable search button
                    document.getElementById('searchBtn').disabled = false;
                    
                    showMessage('Location found! Click "Search Nearby" to find places.', 'success');
                },
                error => {
                    let errorMsg = 'Unable to get your location. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += 'Please allow location access.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'Location request timed out.';
                            break;
                        default:
                            errorMsg += 'An unknown error occurred.';
                    }
                    showMessage(errorMsg, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        // Show message
        function showMessage(text, type) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="message message-${type}">${text}</div>`;
        }

        // Initialize UI
        function initUI() {
            // Create category buttons
            const categoryButtonsDiv = document.getElementById('categoryButtons');
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `category-btn ${selectedCategories.includes(cat.id) ? 'active' : ''}`;
                btn.innerHTML = `${cat.emoji} ${cat.label}`;
                btn.onclick = () => toggleCategory(cat.id);
                categoryButtonsDiv.appendChild(btn);
            });
            
            // Filter button
            document.getElementById('filterBtn').onclick = toggleFilters;
            
            // Search button
            document.getElementById('searchBtn').onclick = searchPlaces;
            
            // Distance slider
            const distanceSlider = document.getElementById('distanceSlider');
            distanceSlider.oninput = (e) => {
                maxDistance = parseInt(e.target.value);
                const label = document.getElementById('distanceLabel');
                label.textContent = `Maximum Distance: ${maxDistance < 1000 ? maxDistance + 'm' : (maxDistance/1000).toFixed(1) + 'km'}`;
                if (places.length > 0) {
                    displayPlaces();
                }
            };
            
            updateFilterCount();
        }

        // Toggle filters panel
        function toggleFilters() {
            const panel = document.getElementById('filtersPanel');
            panel.classList.toggle('show');
        }

        // Toggle category
        function toggleCategory(categoryId) {
            const index = selectedCategories.indexOf(categoryId);
            if (index > -1) {
                selectedCategories.splice(index, 1);
            } else {
                selectedCategories.push(categoryId);
            }
            
            // Update button state
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach((btn, i) => {
                if (categories[i].id === categoryId) {
                    btn.classList.toggle('active');
                }
            });
            
            updateFilterCount();
            if (places.length > 0) {
                displayPlaces();
            }
        }

        // Update filter count
        function updateFilterCount() {
            const count = selectedCategories.length;
            document.getElementById('filterCount').textContent = count > 0 ? `(${count})` : '';
        }

        // Calculate distance
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return Math.round(R * c);
        }

        // Build Overpass query
        function buildOverpassQuery() {
            if (!userLocation) return null;
            
            const [lat, lon] = userLocation;
            const queries = categories
                .filter(cat => selectedCategories.includes(cat.id))
                .map(cat => {
                    const parts = cat.query.split('|');
                    return parts.map(part => `node[${part}](around:${maxDistance},${lat},${lon});`).join('\n');
                })
                .join('\n');
            
            return `
                [out:json][timeout:25];
                (
                    ${queries}
                );
                out body;
                >;
                out skel qt;
            `;
        }

        // Search places
        async function searchPlaces() {
            if (!userLocation) {
                showMessage('Please allow location access to search nearby places', 'error');
                return;
            }

            const searchBtn = document.getElementById('searchBtn');
            const searchBtnText = document.getElementById('searchBtnText');
            searchBtn.disabled = true;
            searchBtnText.textContent = 'Searching...';
            
            // Show loading state
            document.getElementById('placeList').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Searching for nearby places...</p>
                </div>
            `;

            try {
                const query = buildOverpassQuery();
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query,
                });

                if (!response.ok) throw new Error('Failed to fetch places');

                const data = await response.json();
                
                // Process places
                places = data.elements
                    .filter(place => place.tags && place.tags.name && place.lat && place.lon)
                    .map(place => {
                        // Determine category
                        let category = 'attraction';
                        if (place.tags.amenity === 'restaurant') category = 'restaurant';
                        else if (place.tags.amenity === 'cafe') category = 'cafe';
                        else if (place.tags.amenity === 'bar' || place.tags.amenity === 'pub') category = 'bar';
                        else if (place.tags.leisure === 'park' || place.tags.leisure === 'garden') category = 'park';
                        else if (place.tags.highway === 'footway' || place.tags.highway === 'path') category = 'trail';
                        else if (place.tags.tourism) category = 'attraction';

                        // Calculate distance
                        const distance = calculateDistance(
                            userLocation[0], userLocation[1],
                            place.lat, place.lon
                        );

                        return {
                            id: place.id,
                            name: place.tags.name,
                            category,
                            lat: place.lat,
                            lon: place.lon,
                            distance,
                            cuisine: place.tags.cuisine,
                            opening_hours: place.tags.opening_hours,
                            website: place.tags.website,
                            phone: place.tags.phone,
                            address: formatAddress(place.tags),
                        };
                    })
                    .sort((a, b) => a.distance - b.distance)
                    .slice(0, 50);

                showMessage(`Found ${places.length} places nearby!`, 'success');
                displayPlaces();
            } catch (err) {
                showMessage('Failed to search places. Please try again.', 'error');
                console.error('Search error:', err);
                document.getElementById('placeList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <p>Failed to load places. Please try again.</p>
                    </div>
                `;
            } finally {
                searchBtn.disabled = false;
                searchBtnText.textContent = 'Search Nearby';
            }
        }

        // Format address
        function formatAddress(tags) {
            const parts = [];
            if (tags['addr:housenumber']) parts.push(tags['addr:housenumber']);
            if (tags['addr:street']) parts.push(tags['addr:street']);
            if (tags['addr:city']) parts.push(tags['addr:city']);
            return parts.join(', ') || '';
        }

        // Display places
        function displayPlaces() {
            const filtered = places.filter(place => 
                selectedCategories.includes(place.category) && place.distance <= maxDistance
            );
            
            const placeListDiv = document.getElementById('placeList');
            document.getElementById('resultsTitle').textContent = `Nearby Places (${filtered.length} found)`;
            
            if (filtered.length === 0) {
                placeListDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>No places found matching your filters. Try increasing the distance or selecting more categories.</p>
                    </div>
                `;
                return;
            }
            
            placeListDiv.innerHTML = filtered.map(place => {
                const cat = categories.find(c => c.id === place.category);
                const distanceText = place.distance < 1000 ? `${place.distance}m` : `${(place.distance/1000).toFixed(1)}km`;
                
                return `
                    <div class="place-card">
                        <div class="place-header">
                            <h3 class="place-name">${place.name}</h3>
                            <span class="place-category">${cat.emoji} ${cat.label}</span>
                        </div>
                        <div class="place-details">
                            <p>üìç ${distanceText} away</p>
                            ${place.cuisine ? `<p>üç¥ ${place.cuisine}</p>` : ''}
                            ${place.opening_hours ? `<p>üïê ${place.opening_hours}</p>` : ''}
                            ${place.address ? `<p>üìÆ ${place.address}</p>` : ''}
                            ${place.phone ? `<p>üìû ${place.phone}</p>` : ''}
                        </div>
                        <div class="place-actions">
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${place.lat},${place.lon}&travelmode=walking" 
                               target="_blank" 
                               rel="noopener noreferrer" 
                               class="action-link directions-link">
                                üö∂ Walking Directions
                            </a>
                            ${place.website ? `
                                <a href="${place.website}" 
                                   target="_blank" 
                                   rel="noopener noreferrer" 
                                   class="action-link website-link">
                                    üåê Website
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Start the app
        window.onload = init;
    </script>
</body>
</html>
